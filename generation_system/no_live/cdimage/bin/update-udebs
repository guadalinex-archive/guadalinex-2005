#! /bin/sh
set -e

[ -z "$CDIMAGE_ROOT" ] && echo "CDIMAGE_ROOT is not defined!!! You must do: export CDIMAGE_ROOT=/your_path_to_cdimage" && exit
. "$CDIMAGE_ROOT/etc/config"

MIRROR="http://archive.ubuntu.com/ubuntu"
LOG=$CDIMAGE_ROOT/log/update-udebs.log
> $LOG

cd $CDIMAGE_ROOT/scratch/$PROJECT/tmp
[ ! -d fresh_udebs ] && mkdir fresh_udebs
cd fresh_udebs

[ -f breezy-install-i386.list ] && rm breezy-install-i386.list
wget http://cdimage.ubuntulinux.org/daily/current/breezy-install-i386.list

cat breezy-install-i386.list | grep ^/pool/ | grep .udeb\$ > fresh_udebs_list

for x in $(cat fresh_udebs_list)
do
	PKG_TEST=""
	UDEB_FILE=$(basename $x)
	UDEB_NAME=${UDEB_FILE/_*/}
	TMP_VERSION1=${UDEB_FILE/_all.udeb/}; TMP_VERSION2=${TMP_VERSION1/_i386.udeb/}; UDEB_VERSION=${TMP_VERSION2/*_/}
	UDEB_DIR=${x/\/*.udeb/}
	UDEB_DIR=$(echo $x | awk '{ match($1,/(\/.*\/).+(.*\.udeb)/, arr); print arr[1]}')

	echo $UDEB_NAME >> $LOG

	if [ -d $CDIMAGE_ROOT/ftp$UDEB_DIR ]; then
		cd $CDIMAGE_ROOT/ftp$UDEB_DIR
	
		PKG_TEST=$(find -name "$UDEB_NAME\_*.udeb")
		echo $PKG_TEST >> $LOG
		if [ "$PKG_TEST" == "" ]; then
			wget $MIRROR"/"$x
			[ "$?" == "0" ] && echo "Downloaded new udeb: $x" >> $LOG
		else
			LOCAL_VERSION_TMP=$(dpkg --field $PKG_TEST Version)
			LOCAL_VERSION=${LOCAL_VERSION_TMP/Version:/}
			echo "Local: $LOCAL_VERSION  External: $UDEB_VERSION" >> $LOG
			if dpkg --compare-versions "$UDEB_VERSION" gt "$LOCAL_VERSION"; then
				wget $MIRROR$x
				[ "$?" == "0" ] && rm $PKG_TEST && echo "Upgraded udeb: $UDEB_NAME" >> $LOG
			else
				echo "Local version is ok" >> $LOG
			fi
		fi
	else
		mkdir -p $CDIMAGE_ROOT/ftp$UDEB_DIR
		cd $CDIMAGE_ROOT/ftp$UDEB_DIR
		wget $MIRROR$x
		[ "$?" == "0" ] && echo "Downloaded new udeb: $x" >> $LOG
	fi
		
	echo "-----------------" >> $LOG
done
