#!/bin/sh
# Search the image in the local disks
PREREQ="tmpfs"

prereqs()
{
	echo "$PREREQ"
}

case $1 in
# get pre-requisites
prereqs)
	prereqs
	exit 0
	;;
esac


disks=""
for device in /sys/block/* ; do
        if [ -e ${device}/device ]; then
                disk=${device#/sys/block/}
                ls ${device}/${disk}* > /dev/null 2>&1
                if [ $? = 0  ]; then
                        for partition in ${device}/${disk}* ; do
                                disks="${disks} ${partition#${device}/}"
                        done
                else
                        disks="${disks} ${disk}"
                fi
        fi
done


modprobe -q isofs >> /tmp/initramfs.debug 2>&1
mkdir -p /mnt/dev >> /tmp/initramfs.debug 2>&1
found=n
for disk in $disks; do
	mount -t auto -o ro /dev/$disk /mnt/dev >> /tmp/initramfs.debug 2>&1
	if [ -e /mnt/dev/META/META.squashfs ]; then
		found=y
		break
	else
		umount /mnt/dev >> /tmp/initramfs.debug 2>&1
	fi
done
if [ x${found} = xy ]; then
	echo "LOCAL: image mounted" >> /tmp/initramfs.debug
	exit 0
else
	echo "LOCAL: ERROR -> image non mounted" >> /tmp/initramfs.debug
	exit 1
fi





