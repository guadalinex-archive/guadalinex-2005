--- ubuntu-express	2005-07-15 11:54:57.000000000 +0100
+++ installer	2005-07-15 17:20:58.108976696 +0100
@@ -12,8 +12,23 @@
     source = '/source'
     target = '/target'
 
+    def frontend(self, type='text'):
+      ui = gettatr(__import__('frontend.%s' % type), type)
+
+      try:
+        self.wizard = ui()
+        hostname = self.wizard.get_hostname()
+        timezone = self.wizard.get_timezone()
+        keymap   = self.wizard.get_keymap()
+        fullname = self.wizard.get_fullname()
+        user, password = self.wizard.get_user()
+        mountpoints = self.wizard.get_hostname()
+      finally:
+        self.install(mountpoints,timezone,keymap,username,password,fullname,hostname)
+
     def install(self, mountpoints, timezone, keymap, username, password, fullname,
                 hostname):
+	self.wizard.get_partitions()
         self.mount_target(mountpoints)
         self.mount_source()
         try:
@@ -124,7 +139,9 @@
                 fqpath = os.path.join(self.source, dirpath, name)
 
                 if os.path.isfile(fqpath):
-                    files.append((relpath, os.path.getsize(fqpath)))
+		    size = os.path.getsize(fqpath)
+		    total_size += size	
+                    files.append((relpath, size))
                 else:
                     files.append((relpath, None))
 
@@ -137,19 +154,34 @@
             copy.stdin.write(path + '\0')
             if size is not None:
                 copied_bytes += size
+            per = (copied_bytes * 100) / total_size
+            self.wizard.set_progress(per)
 
         copy.stdin.close()
         copy.wait()
         
 
     def mount_source(self):
-        self.ex('losetup', '/dev/cloop1', '/cdrom/casper/filesystem.cloop')
+	from os import path
+	path = '/cdrom/casper/filesystem.'
+	files = [path + 'cloop', path + 'squashfs']
+	for f in files:
+		if path.isfile(f) and path.splitext(f)[1] == '.cloop':
+			file = f
+			self.dev = '/dev/cloop1'
+		elif path.isfile(f) and path.splitext(f)[1] == '.squashfs':
+			file = f
+			self.dev = '/dev/loop3'
+		else return -1			
+
+        self.ex('losetup', self.dev, file)
         os.mkdir(self.source)
-        self.ex('mount', '/dev/cloop1', self.source)
+        self.ex('mount', self.dev, self.source)
+	return 0
 
     def unmount_source(self):
         self.ex('umount', self.source)
-        self.ex('losetup', '-d', '/dev/cloop1')
+        self.ex('losetup', '-d', self.dev)
 
     def ex(self, *args):
         status = subprocess.call(args)
@@ -178,3 +210,5 @@
 
 if __name__ == '__main__':
     Installer().install({'/' : sys.argv[1]}, 'US/Pacific', 'dvorak', 'mdz', 'mdz2', 'Matt Zimmerman', 'ubuntu')
+
+# vim:ai:et:sts=4:tw=80:sw=4:
